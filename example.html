<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8" />
		<title> GeoMap.js </title>
		<meta name="description" content="XXX" />
		<meta name="keywords" content="k1,k2" />
		<meta name="author" content="Tim Yang" />
		<script type="text/javascript" src="jslib/jquery-1.8.2.min.js"></script>
		<script type="text/javascript" src="jslib/tuna.js"></script>
		<script type="text/javascript" src="jslib/raphael-min.js"></script>
		<script type="text/javascript" src="geomap/geomap.js"></script>
	</head>
	<body style="background:#000;">
		<p style="font-size:12px;color:#0c0">点击中国地图，可以看到更多示例<p>
		<div id="text" style="width:100%;height:30px;color:#0c0"></div>
		<div id="map" style="width:1000px;height:650px;margin:0 auto;"></div>
		<script>
			// 部分城市的坐标
			var aCitys = {
				la:{y:34.0396,x:-118.2661},
				toronto:{y:43.6667,x:-79.4167},
				ottawa:{y:45.4167,x:-75.7000},
				ny:{y:40.71435280,x:-74.00597309999999},
				mxgc:{y : 19.43260770,x : -99.1332080},
				bynsals:{y : -34.60372320,x : -58.38159310},
				brasilia:{y:-16.2119,x:-44.4308},
				riodeJaneiro:{y : -22.90353930,x : -43.20958690},
				madrid:{y:40.4086,x:-3.6922},
				london:{y:51.5142,x:-0.0931},
				amsterdam:{y:52.3500,x:4.9167},
				paris:{y:48.8667,x:2.3333},
				rome:{y:44.4833,x:11.3333},
				Jerusalem:{y:31.7800,x:35.2300},
				moscow:{y:55.7522,x:37.6156},	
				bj:{y:39.90,x:116.42},
				tokyo:{y:35.6850,x:139.7514},
				sh:{y:31.14,x:121.29},
				hk:{y:22.39,x:114.1},
				taibei:{y:25.03,x:121.30},
				sydney:{y:-33.86748690,x:151.20699020}
			};
			
			// 创建地图画布
			var map = GeoMap.create('#map');
			
			// 设置参数：地图路径数据和缩放倍数，加载提示文字的颜色
			var config = {
				srcPath : 'http://127.0.0.1/geomap/json/world.geo.json',
                scale : {x:2.7,y:3},
                style : {
					'fill' : '#000',
					'stroke' : '#070',
					'stroke-width' : 0.8,
					'stroke-linejoin' : 'round'
				},
				loadingTxt : {
					'fill' : '#0c0'
				}
			};
			
			// 渲染地图
			map.render(config, function(){
				
				// 给地图各个区块设置鼠标经过事件
				var ps = map.mapPaths;
				$.each(ps, function(k, v){
					v.hover(function(){
						$('#text').html(k);
						this.attr({fill:"#0c0"});
					},function(){
						$('#text').html('');
						this.attr(map.defaultConfig.style);
					});
				});
				
				// 在地图上标出一些城市
				$.each(aCitys, function(k, v){
					var c;
					c = map.setPoint({
						'x':v.x,
						'y':v.y,
						'r':1.5,
						'stroke' : '#0c0',
						'stroke-width' : 1.2,
						'stroke-linejoin' : 'round',
						'fill':"#000",
						opacity:1
					});
					// 城市的标点增加泛光效果
					c.glow({color : '#0c0'});
				});
				
				// 将城市用线连起来
				var linePoints = [];
				$.each(aCitys, function(k ,v){
					linePoints.push(v);
				});
				map.setLine({
					'ps':linePoints,
					'stroke' : '#0c0',
					'stroke-width' : 0.6,
					'stroke-linejoin' : 'round'
				});
				
				// 点击中国，切换到中国地图
				ps.China.click(function(){
					$('p').html('');
					config.srcPath = 'http://127.0.0.1/geomap/json/china.geo.json';
					config.scale = {x:10,y:13};
					config.style['stroke-width'] = '1.2';
					map.render(config, function(){
						// 载入部分中国城市，画上点
						$.ajax({
							url:'http://127.0.0.1/geomap/json/china.province.city.json',
							dataType: 'json'
						}).done(function(d){
							// 画出中国的部分城市
							setChinaCity(d);

							// 中国城市动态连线
							var linePoints = [];
							$.each(d, function(k, v){
								linePoints.push({
									'x':v.log*1,
									'y':v.lat*1
								});
							});
							console.log(linePoints);
							map.animateLine({
								'ps':linePoints,
								'stroke' : '#0c0',
								'stroke-width' : 1.6,
								'stroke-linejoin' : 'round'
							});
						});
					});
				});
				
			});
			
			// impl是tuna类库里的一个方法，用于给对象动态增加方法
			// 这里使用impl方法，给GeoMap对象动态增加了一个动画方法，让若干条光线不停在各个城市间移动
			GeoMap.impl({
				animateLine : function(b){
					var self = this,
						a = {
							"ps":[],
							"stroke": "#238CC3",
							"stroke-width": 1,
							"stroke-linejoin": "round"
						},
						d = [],
						x, y, l;
		
					$.extend(true, a, b);
					
					self.canvas.path()
					
					var ps = [];
					// 将所有点的坐标都转换为当前地图平面坐标
					for(var i=0, len=a.ps.length; i<len; i++){
						ps[i] = {};
						ps[i].x = (a.ps[i].x + self.offset.x) * self.scale.x;
						ps[i].y = (self.offset.y - a.ps[i].y) * self.scale.y;
					}
					
					aLine(0,200,a);
					
					aLine(1,200,a);
					
					aLine(2,200,a);
					
					aLine(3,200,a);
					
					function aLine(idx,spd,a){
						var d = 'M' + ps[idx].x + ',' + ps[idx].y;
						var l = self.canvas.path(d).attr(a);
						
						do{
							
							var next = Math.floor(Math.random()*(ps.length));
							
						}while(next == idx);

						l.animate({path:d+'L'+ps[next].x+','+ps[next].y},spd,function(){
							l.animate({path:'M'+ps[next].x+','+ps[next].y},spd);
							aLine(next,spd,a);
						});
					}
				}
			});
			
			
			function setChinaCity(d){
				$.each(d, function(k, v){
					var c = map.setPoint({
						'x':v.log*1,
						'y':v.lat*1,
						'r':2,
						'stroke' : '#0c0',
						'stroke-width' : 1,
						'stroke-linejoin' : 'round',
						'fill':"#0c0",
						opacity:1					
					});
					c.glow({color:'#0c0'});
				});
			}


		</script>
	</body>
</html>

